# Docker Volumes Storage Guide

This guide explains how to configure repository storage using Docker volumes for optimal performance and data persistence.

## Why Docker Volumes?

According to the [Docker documentation](https://docs.docker.com/engine/storage/volumes/), volumes are the preferred mechanism for persisting data generated by and used by Docker containers. Volumes have several advantages over bind mounts:

- **Better performance** on Docker Desktop
- **Managed by Docker** - easier backup, restore, and migration
- **Cross-platform compatibility** - work on Linux and Windows containers
- **More secure** - volumes can be safely shared among multiple containers
- **Volume drivers** allow storing data on remote hosts or cloud providers

## Production Configuration

### Docker Compose with Named Volumes

```yaml
version: '3.8'
services:
  github-sync-server:
    image: your-github-sync-image
    ports:
      - "5000:5000"
    volumes:
      - repo_storage:/app/repos          # Named volume for repositories
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - REPOS_PATH=/app/repos            # Configure repository path
      - DATABASE_URL=postgresql://...
    labels:
      - restart-after=github-sync

  # Your application containers
  odoo:
    image: odoo:17
    container_name: odoo-odoo-1
    volumes:
      - repo_storage:/mnt/server-backend:ro  # Read-only access to repos
    labels:
      - restart-after=server-backend     # Restart when server-backend updates

  backend-app:
    image: your-backend-image
    container_name: server-backend-app
    volumes:
      - repo_storage:/app/code:ro        # Read-only access to source code
    labels:
      - restart-after=server-backend

volumes:
  repo_storage:                          # Named volume declaration
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/github-sync/repos     # Host path for volume
```

### Docker Run Commands

```bash
# Create named volume
docker volume create repo_storage

# Run GitHub Sync Server with volume
docker run -d \
  --name github-sync-server \
  -p 5000:5000 \
  -v repo_storage:/app/repos \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -e REPOS_PATH=/app/repos \
  your-github-sync-image

# Run application containers with shared volume
docker run -d \
  --name odoo-odoo-1 \
  -v repo_storage:/mnt/server-backend:ro \
  -l restart-after=server-backend \
  odoo:17

docker run -d \
  --name server-backend-app \
  -v repo_storage:/app/code:ro \
  -l restart-after=server-backend \
  your-backend-image
```

## Volume Configuration Options

### Local Driver with Custom Location

```yaml
volumes:
  repo_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/repositories        # Custom host directory
```

### NFS Network Storage

```yaml
volumes:
  repo_storage:
    driver: local
    driver_opts:
      type: nfs
      o: addr=nfs-server.example.com,rw
      device: ":/path/to/repos"
```

### Cloud Storage (AWS EFS)

```yaml
volumes:
  repo_storage:
    driver: local
    driver_opts:
      type: nfs4
      o: addr=fs-12345.efs.region.amazonaws.com,rw,accesspoint=fsap-12345
      device: ":/"
```

## Environment Variables

Configure the GitHub Sync Server using these environment variables:

```bash
# Repository storage path (inside container)
REPOS_PATH=/app/repos

# Database connection
DATABASE_URL=postgresql://user:pass@host/db

# Optional: Enable volume auto-detection
AUTO_DETECT_VOLUMES=true

# Optional: Volume name for repository storage
REPO_VOLUME_NAME=repo_storage
```

## Directory Structure

With Docker volumes, your repository structure will be:

```
/var/lib/docker/volumes/repo_storage/_data/
├── server-backend/
│   ├── .git/
│   ├── addons/
│   └── ...
├── frontend-app/
│   ├── .git/
│   ├── src/
│   └── ...
└── api-service/
    ├── .git/
    ├── app/
    └── ...
```

## Backup and Restore

### Backup Volume Data

```bash
# Create backup archive
docker run --rm \
  -v repo_storage:/source \
  -v $(pwd):/backup \
  alpine tar czf /backup/repos-backup.tar.gz -C /source .

# Or use rsync for incremental backups
docker run --rm \
  -v repo_storage:/source \
  -v /backup/location:/dest \
  alpine rsync -av /source/ /dest/
```

### Restore Volume Data

```bash
# Restore from backup
docker run --rm \
  -v repo_storage:/target \
  -v $(pwd):/backup \
  alpine tar xzf /backup/repos-backup.tar.gz -C /target
```

## Migration from Bind Mounts

If you're currently using bind mounts, migrate to volumes:

1. **Stop containers**:
   ```bash
   docker-compose down
   ```

2. **Copy data to volume**:
   ```bash
   docker run --rm \
     -v /old/bind/mount/path:/source \
     -v repo_storage:/dest \
     alpine cp -a /source/. /dest/
   ```

3. **Update docker-compose.yml** to use named volumes

4. **Start containers**:
   ```bash
   docker-compose up -d
   ```

## Performance Optimization

### Volume Performance Tips

1. **Use local driver** for best performance on single-host deployments
2. **Enable BuildKit** for faster builds with volume caches
3. **Use read-only mounts** for application containers that only read repositories
4. **Consider tmpfs** for temporary data that doesn't need persistence

### Example with Performance Optimizations

```yaml
services:
  github-sync-server:
    volumes:
      - repo_storage:/app/repos:rw       # Read-write for sync operations
      - tmpfs:/tmp                       # Fast temporary storage
    
  application:
    volumes:
      - repo_storage:/app/code:ro        # Read-only for security
      - tmpfs:/app/cache                 # Fast cache storage
    tmpfs:
      - /tmp:size=100M                   # Limit tmpfs size
```

## Monitoring and Troubleshooting

### Check Volume Usage

```bash
# List volumes
docker volume ls

# Inspect volume details
docker volume inspect repo_storage

# Check volume usage
docker system df -v
```

### Volume Permissions

```bash
# Check volume permissions
docker run --rm -v repo_storage:/check alpine ls -la /check

# Fix ownership if needed
docker run --rm -v repo_storage:/fix alpine chown -R 1000:1000 /fix
```

## Security Considerations

1. **Read-only mounts** for application containers
2. **Volume encryption** for sensitive repositories
3. **Access controls** on host directories
4. **Regular backups** with encryption

### Example with Security Features

```yaml
services:
  application:
    volumes:
      - repo_storage:/app/code:ro        # Read-only prevents modification
    security_opt:
      - no-new-privileges:true
    read_only: true                      # Container filesystem read-only
    tmpfs:
      - /tmp:noexec,nosuid,size=100m     # Secure temp storage
```

This configuration ensures optimal performance, security, and maintainability for your GitHub Sync Server repository storage.